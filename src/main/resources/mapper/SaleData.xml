<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.SaleDataMapper">

    <select id="selectQuantitySalesVolume" resultType="com.example.entity.vo.QuantitySalesVolume">
        SELECT
        SUM(sum_quantity_jy) AS quantity,
        SUM(sum_cost_amount_jy) AS cost,
        SUM(sum_amount_jy) AS salesVolume
        FROM
            trs_sal_saledtl_jh_2022
        WHERE customer_name = #{shopName}
        <if test="type == 1">
            AND YEAR(sale_time) = YEAR(#{time}) AND MONTH(sale_time) = MONTH(#{time})
        </if>
        <if test="type == 2">
            AND YEAR(sale_time) = YEAR(#{time})
        </if>
        <if test="type == 3">
            AND YEAR(sale_time) = YEAR(#{time})-1
        </if>
    </select>

    <select id="selectAvgQuantitySalesVolume" resultType="com.example.entity.vo.QuantitySalesVolume">
        SELECT
            AVG(sum_quantity_jy) AS quantity,
            AVG(sum_cost_amount_jy) AS cost,
            AVG(sum_amount_jy) AS salesVolume
        FROM
            trs_sal_saledtl_jh_2022
        WHERE
            customer_name = #{shopName}
    </select>

    <select id="selectNextMonthAmount" resultType="com.example.entity.vo.NextMonthAmount">
        SELECT SUM(sum_cost_amount_jy) AS nextMonthJyAmount,SUM(sum_cost_amount_fy) AS nextMonthFyAmount
        FROM trs_sal_saledtl_jh_2022
        WHERE customer_name = #{shopName} AND YEAR(sale_time) = YEAR(#{time} - INTERVAL 1 YEAR)
          AND MONTH(sale_time) = MONTH(#{time} - INTERVAL 1 YEAR)
    </select>


    <select id="selectProfit" resultType="double">
        SELECT SUM(sum_amount_jy - sum_cost_amount_jy) AS profit
        FROM trs_sal_saledtl_jh_2022
        WHERE  customer_name = #{shopName} AND YEAR(sale_time) = YEAR(#{time} - INTERVAL 1 YEAR)
          AND MONTH(sale_time) = MONTH(#{time} - INTERVAL 1 YEAR)
    </select>

    <select id="selectShopMonthData" resultType="com.example.entity.vo.ShopMonthData">
        SELECT biz_month as shopMonth,SUM(sum_quantity_jy) as jyAmount,ROUND(SUM(sum_cost_amount_jy
            ),2) as jyCost,ROUND(SUM(sum_amount_jy)-SUM(sum_cost_amount_jy),2
            ) as jyGrossProfit,SUM(sum_quantity_fy) as fyAmount,ROUND(SUM(sum_cost_amount_fy
            ),2) as fyCost,ROUND(SUM(sum_amount_fy)-SUM(sum_cost_amount_fy),2
            ) as fyGrossProfit FROM trs_sal_saledtl_jh_2022 WHERE customer_name = #{shopName}  GROUP BY biz_month
    </select>

    <select id="selectFyZFPurchaseReminder" resultType="com.example.entity.vo.PurchaseReminder">
        SELECT goods_name as goodName,dysl,sysl,CONCAT(ROUND(((dysl-sysl)/sysl)*100,2),'%') as fd
        from (
                 SELECT goods_name,(SELECT sum(quantity) FROM trs_sal_saledtl_jh_2022 as a WHERE a.goods_name=b.goods_name AND is_tobacco=0 AND MONTH(sale_time) = MONTH(#{time}) ) as dysl,
    sum(quantity) AS sysl
        FROM trs_sal_saledtl_jh_2022 as b
        WHERE customer_name = #{shopName}
          AND MONTH(sale_time) = MONTH(#{time} - INTERVAL 1 MONTH) AND is_tobacco=0
        GROUP BY goods_name
            ) as t ORDER BY (ROUND(((dysl-sysl)/sysl)*100,2)) desc
            LIMIT 10
    </select>




</mapper>
